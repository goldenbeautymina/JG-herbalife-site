<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ç·šä¸Šé»é¤ï½œJ&G ç‡Ÿé¤Šä¿±æ¨‚éƒ¨</title>
  <meta name="description" content="J&G ç·šä¸Šé»é¤ï¼šè‡ªé¸å£å‘³ã€ç”œåº¦ã€å†°é‡ã€å–é¤æ™‚é–“èˆ‡ä»˜æ¬¾æ–¹å¼ï¼Œå¿«é€Ÿé€å–®åˆ°é–€å¸‚ã€‚">
  <link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;600;700;900&display=swap" rel="stylesheet">
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    :root{--brand:#10b981;--brand-600:#059669;--brand-50:#ecfdf5;--ink:#0f172a;--muted:#64748b;--bg:#f8fafc;--card:#fff;--shadow:0 14px 35px rgba(2,6,23,.08);--radius:18px;--max:1080px}
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--ink);font-family:"Noto Sans TC",system-ui,-apple-system,"Segoe UI","PingFang TC","Microsoft JhengHei","Helvetica Neue",Arial,sans-serif}
    img{max-width:100%;display:block} a{text-decoration:none;color:inherit}
    .container{width:min(100%,var(--max));margin:auto;padding:22px}
    .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    .brand{display:flex;gap:.65rem;align-items:center;font-weight:900}
    .logo{width:36px;height:36px;border-radius:12px;background:linear-gradient(135deg,var(--brand),#34d399);display:grid;place-items:center;color:#fff;box-shadow:var(--shadow)}
    .btn{display:inline-flex;align-items:center;gap:.5rem;padding:.9rem 1.15rem;border-radius:999px;border:0;background:var(--brand);color:#fff;font-weight:800;box-shadow:var(--shadow);cursor:pointer;transition:.2s}
    .btn:hover{background:var(--brand-600);transform:translateY(-1px)}
    .btn-ghost{background:#fff;color:var(--brand);border:2px solid var(--brand)} .btn-ghost:hover{background:var(--brand-50)}
    .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:22px}
    .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden}
    .card .head{padding:16px 18px;border-bottom:1px solid #e2e8f0;font-weight:900}
    .card .body{padding:18px}
    .field{margin:12px 0}
    .label{font-size:.9rem;color:#334155;font-weight:800;margin:0 0 6px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    input[type="number"],select,input[type="text"],textarea,input[type="time"]{width:100%;padding:.9rem;border:1px solid #e5e7eb;border-radius:14px;font-size:1rem;background:#fff}
    textarea{min-height:84px;resize:vertical}
    .muted{color:var(--muted)}
    .product{display:grid;grid-template-columns:140px 1fr;gap:16px;align-items:center}
    .thumb{border-radius:14px;overflow:hidden}
    .price{font-weight:900;color:#065f46}
    .kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:6px}
    .kpi{background:#f1f5f9;border-radius:12px;padding:.45rem .6rem;text-align:center;font-size:.9rem}
    .total{display:flex;justify-content:space-between;align-items:center;padding:12px 18px;border-top:1px solid #e2e8f0}
    .total .n{font-weight:900;font-size:1.25rem;color:#065f46}
    .hint{background:#ecfeff;border:1px solid #bae6fd;color:#0369a1;border-radius:12px;padding:.6rem .8rem;margin-top:8px}
    .ok{background:#ecfdf5;border:1px solid #86efac;color:#065f46;border-radius:12px;padding:.7rem .9rem;margin-top:10px;display:none}
    .err{background:#fef2f2;border:1px solid #fecaca;color:#991b1b;border-radius:12px;padding:.7rem .9rem;margin-top:10px;display:none}
    .success-wrap{display:none}
    .success{padding:26px;text-align:center}
    .success h2{margin:.2rem 0 .25rem} .actions{display:flex;gap:.6rem;justify-content:center;flex-wrap:wrap;margin-top:12px}
    .hr{height:1px;background:#e2e8f0;margin:14px 0}
    .radio-row{display:flex;gap:12px;flex-wrap:wrap}
    .radio{display:flex;align-items:center;gap:.4rem;background:#fff;border:1px solid #e5e7eb;border-radius:999px;padding:.5rem .8rem;cursor:pointer}
    .radio input{accent-color:#10b981}
    @media (max-width: 900px){.grid{grid-template-columns:1fr}}
  </style>
  <script>
    /* ====== è«‹æ›¿æ›æˆä½ çš„å¯¦éš›å€¼ ====== */
    const ORDER_API = 'https://script.google.com/macros/s/AKfycbyUM0WoyW1CGtatVPEesG7KdOjeQ3Ozz1V587QLPK09iGtvm5AkVJtmXyltqMVSgwxl/exec'; // â† GAS /exec
    const LIFF_ID   = '2007954350-XMv4Vpwr';                                       // â† LIFF IDï¼ˆé URLï¼‰
    const HOME_URL  = './';                                                       // å›é¦–é ç”¨

    // ç”¢å“è³‡æ–™ï¼ˆid å¿…é ˆèˆ‡ GAS / è©¦ç®—è¡¨ä¸€è‡´ï¼‰
    const PRODUCTS = {
      'pdm-vanilla': { id:'pdm-vanilla', name:'è›‹ç™½é£²æ–™ç²‰', flavor:'é¦™è‰ Vanilla', price:120,
        img:'https://images.unsplash.com/photo-1517677208171-0bc6725a3e60?q=80&w=1200&auto=format&fit=crop'},
      'pdm-choco'  : { id:'pdm-choco'  , name:'è›‹ç™½é£²æ–™ç²‰', flavor:'å·§å…‹åŠ› Chocolate', price:120,
        img:'https://images.unsplash.com/photo-1542444459-db63c9f5b3d3?q=80&w=1200&auto=format&fit=crop'},
      'pdm-berry'  : { id:'pdm-berry'  , name:'è›‹ç™½é£²æ–™ç²‰', flavor:'é‡è“ Wild Berry', price:120,
        img:'https://images.unsplash.com/photo-1512621776951-a57141f2eefd?q=80&w=1200&auto=format&fit=crop'}
    };

    const $  = s => document.querySelector(s);
    const qs = s => new URLSearchParams(location.search).get(s)||'';
    const pid = qs('product') || 'pdm-vanilla';
    let profile = { userId:'', displayName:'' };

    async function init(){
      const p = PRODUCTS[pid] || PRODUCTS['pdm-vanilla'];
      $('#p-img').src = p.img; $('#p-title').textContent = p.name;
      $('#p-flavor').textContent = p.flavor; $('#unit').textContent = p.price;
      updateTotal();

      // LIFF å˜—è©¦
      try{
        if(LIFF_ID && window.liff){
          await liff.init({ liffId: LIFF_ID });
          if(liff.isLoggedIn()){
            const prof = await liff.getProfile();
            profile.userId = prof.userId || '';
            profile.displayName = prof.displayName || '';
            $('#displayName').value = profile.displayName || '';
            $('#linehint').textContent = 'å·²å¾ LINE å–å¾—æš±ç¨±ï¼›è‹¥éœ€æ›´æ­£å¯ä¿®æ”¹å¾Œå†é€å‡ºã€‚';
          }else{
            $('#linehint').textContent = 'ç›®å‰éå¾ LINE é–‹å•Ÿï¼Œè«‹è¼¸å…¥æ‚¨çš„ç¨±å‘¼å¾Œé€å–®ã€‚';
          }
        }else{
          $('#linehint').textContent = 'å¦‚åœ¨ LINE é–‹å•Ÿå¯è‡ªå‹•å¸¶å…¥æš±ç¨±ï¼›ç›®å‰å¯ç›´æ¥å¡«å¯«ã€‚';
        }
      }catch(e){
        console.log('LIFF init å¤±æ•—ï¼š', e);
        $('#linehint').textContent = 'æš«ç„¡æ³•å¾ LINE å–å¾—æš±ç¨±ï¼Œå¯ç›´æ¥å¡«å¯«ã€‚';
      }

      // ç¶å®š
      $('#qty').addEventListener('input', updateTotal);
      $('#sugar').addEventListener('change', updateTotal);
      $('#ice').addEventListener('change', updateTotal);
      $('#pickup').addEventListener('change', handlePickupPreset);
      $('#submit').addEventListener('click', submitOrder);
      $('#back').addEventListener('click', ()=> location.href = HOME_URL);
      $('#again').addEventListener('click', ()=> location.href = 'order.html?product='+encodeURIComponent(pid));

      // é è¨­å–é¤æ™‚é–“ï¼šç«‹å³
      handlePickupPreset();
    }

    function updateTotal(){
      const p = PRODUCTS[pid] || PRODUCTS['pdm-vanilla'];
      const qty = Math.max(1, Number($('#qty').value||1));
      $('#qty').value = qty;
      const total = p.price * qty;
      $('#total').textContent = total;
      $('#sum-title').textContent = `${p.name}ï½œ${p.flavor}`;
      $('#sum-qty').textContent   = `æ•¸é‡ Ã— ${qty}`;
      $('#sum-unit').textContent  = `å–®åƒ¹ NT$ ${p.price}`;
    }

    function handlePickupPreset(){
      const v = $('#pickup').value; // now / 15 / 30 / custom
      const t = $('#pickupTime');
      if(v === 'custom'){
        t.disabled = false;
        if(!t.value){ t.value = getRoundedTime(15); }
      }else{
        t.disabled = true;
        if(v === 'now'){ t.value = ''; }
        if(v === '15'){ t.value = getRoundedTime(15); }
        if(v === '30'){ t.value = getRoundedTime(30); }
      }
    }

    function getRoundedTime(mins){
      const d = new Date();
      d.setMinutes(d.getMinutes() + Number(mins||0));
      const hh = String(d.getHours()).padStart(2,'0');
      const mm = String(d.getMinutes()).padStart(2,'0');
      return `${hh}:${mm}`;
    }

    function showToast(el, msg){ el.textContent = msg; el.style.display = 'block'; setTimeout(()=> el.style.display='none', 4200); }

    async function submitOrder(){
      $('.ok').style.display='none'; $('.err').style.display='none';
      if(!ORDER_API || !/^https?:\/\//.test(ORDER_API)){
        return showToast($('.err'),'å°šæœªè¨­å®š ORDER_APIï¼Œè«‹åœ¨æª”é ­æ›¿æ›ä½ çš„ GAS /execã€‚');
      }

      const p = PRODUCTS[pid] || PRODUCTS['pdm-vanilla'];
      // å–é¤æ™‚é–“
      const preset = $('#pickup').value; // now / 15 / 30 / custom
      let pickupTimeText = 'ç«‹å³';
      if(preset === '15') pickupTimeText = '15 åˆ†å¾Œ';
      if(preset === '30') pickupTimeText = '30 åˆ†å¾Œ';
      if(preset === 'custom'){
        const t = $('#pickupTime').value;
        pickupTimeText = t ? `è‡ªé¸ ${t}` : 'è‡ªé¸';
      }

      // ä»˜æ¬¾æ–¹å¼
      const payment = document.querySelector('input[name="pay"]:checked')?.value || 'ç¾é‡‘';

      const payload = {
        api: 'order',
        userId: profile.userId || '',
        displayName: ($('#displayName').value || profile.displayName || '').trim() || 'è¨ªå®¢',
        productId: p.id,
        productName: p.name,
        flavor: p.flavor,
        qty: Number($('#qty').value||1),
        sugar: $('#sugar').value,
        ice: $('#ice').value,
        note: $('#note').value||'',
        pickupTime: pickupTimeText,
        payment: payment
      };

      if(!payload.displayName){ return showToast($('.err'),'è«‹è¼¸å…¥æš±ç¨±æˆ–æ‚¨çš„ç¨±å‘¼'); }
      if(!(payload.qty>0)){ return showToast($('.err'),'è«‹ç¢ºèªæ•¸é‡'); }

      const btn = $('#submit'); btn.disabled = true; btn.textContent = 'é€å‡ºä¸­â€¦';
      try{
        const res = await fetch(ORDER_API, {
          method:'POST',
          headers: { 'Content-Type':'text/plain;charset=utf-8' },
          body: JSON.stringify(payload)
        });
        const data = await res.json().catch(()=>({ok:true}));
        if(data && data.ok){
          $('.form-wrap').style.display='none';
          $('.success-wrap').style.display='block';
          $('#order-msg').textContent = data.message || 'è¨‚å–®å·²é€å‡ºï¼Œæ„Ÿè¬ï¼';
        }else{
          throw new Error(data && data.message || 'é€å–®å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
        }
      }catch(err){
        showToast($('.err'),'é€å–®å¤±æ•—ï¼š' + err.message);
      }finally{
        btn.disabled=false; btn.textContent='é€å‡ºè¨‚å–®';
      }
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</head>
<body>
  <div class="container">
    <div class="topbar">
      <div class="brand"><div class="logo">J&G</div>J&G ç‡Ÿé¤Šä¿±æ¨‚éƒ¨</div>
      <button id="back" class="btn btn-ghost">å›é¦–é </button>
    </div>

    <div class="grid">
      <!-- å·¦ï¼šè¡¨å–® -->
      <div class="card form-wrap">
        <div class="head">ç·šä¸Šé»é¤</div>
        <div class="body">
          <!-- å•†å“è³‡è¨Š -->
          <div class="product">
            <div class="thumb"><img id="p-img" alt="å•†å“åœ–ç‰‡"></div>
            <div>
              <div class="muted">å•†å“</div>
              <h2 id="p-title" style="margin:.25rem 0 .15rem">â€”</h2>
              <div id="p-flavor" class="muted">â€”</div>
              <div class="kpis">
                <div class="kpi">è›‹ç™½è³ªè£œçµ¦</div>
                <div class="kpi">ç†±é‡å‹å–„</div>
                <div class="kpi">å®¢è£½ç”œå†°</div>
              </div>
            </div>
          </div>

          <div class="hr"></div>

          <!-- æ•¸é‡ï¼å–®åƒ¹ -->
          <div class="row">
            <div class="field">
              <div class="label">æ•¸é‡</div>
              <input id="qty" type="number" min="1" value="1" />
            </div>
            <div class="field">
              <div class="label">å–®æ¯åƒ¹æ ¼</div>
              <div class="price">NT$ <span id="unit">â€”</span></div>
            </div>
          </div>

          <!-- å®¢è£½é¸é … -->
          <div class="row">
            <div class="field">
              <div class="label">ç”œåº¦</div>
              <select id="sugar">
                <option>ç„¡ç³–</option><option selected>å¾®ç³–</option><option>åŠç³–</option><option>å…¨ç³–</option>
              </select>
            </div>
            <div class="field">
              <div class="label">å†°é‡</div>
              <select id="ice">
                <option>å»å†°</option><option selected>å¾®å†°</option><option>æ­£å¸¸å†°</option>
              </select>
            </div>
          </div>

          <!-- å–é¤æ™‚é–“ -->
          <div class="row">
            <div class="field">
              <div class="label">å–é¤æ™‚é–“</div>
              <select id="pickup">
                <option value="now" selected>ç«‹å³</option>
                <option value="15">15 åˆ†é˜å¾Œ</option>
                <option value="30">30 åˆ†é˜å¾Œ</option>
                <option value="custom">è‡ªé¸æ™‚é–“</option>
              </select>
            </div>
            <div class="field">
              <div class="label">è‡ªé¸æ™‚é–“ï¼ˆHH:MMï¼‰</div>
              <input id="pickupTime" type="time" disabled />
            </div>
          </div>

          <!-- ä»˜æ¬¾æ–¹å¼ -->
          <div class="field">
            <div class="label">ä»˜æ¬¾æ–¹å¼</div>
            <div class="radio-row">
              <label class="radio"><input type="radio" name="pay" value="ç¾é‡‘" checked> ç¾é‡‘</label>
              <label class="radio"><input type="radio" name="pay" value="LINE Pay"> LINE Pay</label>
            </div>
          </div>

          <!-- å‚™è¨» -->
          <div class="field">
            <div class="label">å‚™è¨»</div>
            <textarea id="note" placeholder="ä¾‹å¦‚ï¼šä¸è¦å¥¶ã€åŠ ç‡•éº¥ã€å°‘å†°â€¦"></textarea>
          </div>

          <!-- ä½¿ç”¨è€… -->
          <div class="field">
            <div class="label">æš±ç¨±</div>
            <input id="displayName" type="text" placeholder="åœ¨ LINE å…§é–‹å•Ÿæœƒè‡ªå‹•å¸¶å…¥" />
            <div id="linehint" class="muted" style="margin-top:6px"></div>
          </div>

          <div class="ok"></div>
          <div class="err"></div>
        </div>
        <div class="total">
          <div>
            <div class="muted">åˆè¨ˆ</div>
            <div class="n">NT$ <span id="total">â€”</span></div>
          </div>
          <button id="submit" class="btn">é€å‡ºè¨‚å–®</button>
        </div>
      </div>

      <!-- å³ï¼šè¨‚å–®æ‘˜è¦ -->
      <aside class="card">
        <div class="head">è¨‚å–®æ‘˜è¦</div>
        <div class="body">
          <div style="display:flex;gap:12px;align-items:center">
            <div style="width:68px;height:68px;border-radius:12px;overflow:hidden"><img id="sum-img" src="" alt="" style="width:100%;height:100%;object-fit:cover" onload="document.getElementById('sum-img').src=document.getElementById('p-img').src"></div>
            <div>
              <div id="sum-title" style="font-weight:900;margin-bottom:4px">â€”</div>
              <div id="sum-qty" class="muted">â€”</div>
              <div id="sum-unit" class="muted">â€”</div>
            </div>
          </div>
          <div class="hint">ä¸‹å–®å¾Œæˆ‘å€‘æœƒç›¡å¿«æº–å‚™ï¼Œè«‹æ–¼é–€å¸‚å–é¤æ™‚ä»˜æ¬¾ã€‚è‹¥éœ€å¤§é‡è¨‚è³¼ï¼Œå»ºè­°å…ˆé›»æ´½é–€å¸‚ã€‚</div>
        </div>
      </aside>

      <!-- æˆåŠŸç•«é¢ -->
      <div class="card success-wrap">
        <div class="success">
          <div style="font-size:48px;line-height:1">ğŸ‰</div>
          <h2>è¨‚å–®é€å‡ºæˆåŠŸ</h2>
          <p id="order-msg" class="muted">æ„Ÿè¬æ‚¨çš„è¨‚è³¼ï¼</p>
          <div class="actions">
            <button id="again" class="btn">å†é»ä¸€æ¯</button>
            <button id="back2" class="btn btn-ghost" onclick="location.href=HOME_URL">å›é¦–é </button>
          </div>
        </div>
      </div>

    </div>
  </div>
</body>
</html>
